name: "Ubuntu Docker Cluster"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  setup:
    name: "Ubuntu Docker Cluster"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Start MySQL Server
        run: |
          cd ./examples/wesql-server && ./start_mysql_server.sh

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.20.1

      - name: Compile source
        timeout-minutes: 30
        run: |
          make failpoint-enable
          make build
          make failpoint-disable

      - name: Start WeScale
        run: |
          cd ./examples/wesql-server && ./init_single_node_cluster.sh
          # Wait for port 15306 to be ready
          timeout 300 bash -c 'until nc -z localhost 15306; do sleep 1; done'
          # Save logs to a file for later steps
          docker logs wescale > wescale_logs.txt 2>&1

      - name: Check Vitess Tablets
        run: |
          # Install MySQL client
          sudo apt-get update && sudo apt-get install -y mysql-client
          
          # Execute show vitess_tablets command
          mysql -h127.0.0.1 -P15306 -uroot -ppasswd -e "show vitess_tablets"
          
          # Display WeScale logs if needed
          echo "=== WeScale Logs ==="
          cat wescale_logs.txt